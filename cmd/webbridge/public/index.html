<!DOCTYPE html>
<html>
<head>
    <title>GameServer - Multiplayer Test</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0a0a14;
            color: #e0e0e0;
            font-family: 'Segoe UI', system-ui, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        h1 { 
            color: #00d4ff; 
            margin-bottom: 5px; 
            font-weight: 600;
            letter-spacing: 1px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .status-bar {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            font-size: 13px;
        }
        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ff4757;
        }
        .status-dot.connected { background: #2ed573; }
        #gameCanvas {
            border: 2px solid #1a1a2e;
            border-radius: 12px;
            background: #050508;
        }
        .controls {
            margin-top: 15px;
            display: flex;
            gap: 8px;
        }
        .btn {
            padding: 12px 20px;
            font-size: 14px;
            border: 1px solid #2a2a3e;
            border-radius: 8px;
            cursor: pointer;
            background: #12121a;
            color: #aaa;
            transition: all 0.15s;
        }
        .btn:hover { 
            background: #1a1a28; 
            border-color: #00d4ff;
            color: #fff;
        }
        .btn:active {
            background: #00d4ff;
            color: #000;
        }
        .info { 
            margin-top: 15px; 
            color: #555; 
            text-align: center;
            font-size: 13px;
        }
        .stats {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            padding: 10px 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            color: #888;
        }
        .hud {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
        }
        .hud-row {
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }
        .hud-label { color: #666; }
        .hud-value { color: #00d4ff; font-family: monospace; }
    </style>
</head>
<body>
    <h1>üéÆ GameServer</h1>
    <div class="subtitle">Real-time multiplayer test client</div>
    
    <div class="status-bar">
        <div class="status-item">
            <div id="statusDot" class="status-dot"></div>
            <span id="statusText">Connecting...</span>
        </div>
        <div class="status-item">
            <span>Player:</span>
            <span id="playerName" style="color: #00d4ff;">---</span>
        </div>
        <div class="status-item">
            <span>Players:</span>
            <span id="playerCount" style="color: #2ed573;">0</span>
        </div>
    </div>
    
    <canvas id="gameCanvas" width="500" height="500"></canvas>
    
    <div class="controls">
        <button class="btn" onclick="setName()">‚úèÔ∏è Set Name</button>
        <button class="btn" onmousedown="startMove(-1,0)" onmouseup="stopMove()" ontouchstart="startMove(-1,0)" ontouchend="stopMove()">‚¨ÖÔ∏è</button>
        <button class="btn" onmousedown="startMove(1,0)" onmouseup="stopMove()" ontouchstart="startMove(1,0)" ontouchend="stopMove()">‚û°Ô∏è</button>
        <button class="btn" onmousedown="startMove(0,-1)" onmouseup="stopMove()" ontouchstart="startMove(0,-1)" ontouchend="stopMove()">‚¨ÜÔ∏è</button>
        <button class="btn" onmousedown="startMove(0,1)" onmouseup="stopMove()" ontouchstart="startMove(0,1)" ontouchend="stopMove()">‚¨áÔ∏è</button>
    </div>
    
    <div class="info">
        <p>WASD or Arrow keys to move ‚Ä¢ Click and hold buttons for continuous movement</p>
    </div>
    
    <div class="stats">
        <div>FPS: <span id="fps">--</span></div>
        <div>Ping: <span id="ping">--</span>ms</div>
    </div>
    
    <div class="hud">
        <div class="hud-row">
            <span class="hud-label">Position:</span>
            <span class="hud-value" id="posDisplay">(500, 500)</span>
        </div>
        <div class="hud-row">
            <span class="hud-label">World:</span>
            <span class="hud-value">1000 √ó 1000</span>
        </div>
    </div>

    <script>
        // === CONFIG ===
        const WORLD_W = 1000;
        const WORLD_H = 1000;
        const CANVAS_SIZE = 500;
        const SCALE = CANVAS_SIZE / WORLD_W;
        const PLAYER_RADIUS = 15;
        const SEND_RATE = 20; // ms between input sends

        // === STATE ===
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const playerNameEl = document.getElementById('playerName');
        const playerCountEl = document.getElementById('playerCount');
        const fpsEl = document.getElementById('fps');
        const pingEl = document.getElementById('ping');
        const posDisplay = document.getElementById('posDisplay');

        let ws = null;
        let myId = null;
        let myName = 'Player' + Math.floor(Math.random() * 1000);
        
        // Smooth state - interpolated positions
        let serverState = {};      // Latest from server
        let renderState = {};      // Interpolated for display
        let myServerPos = { x: 500, y: 500 };
        
        // Input state
        let currentInput = { dx: 0, dy: 0 };
        let inputInterval = null;
        
        // Performance tracking
        let lastFrameTime = performance.now();
        let frameCount = 0;
        let lastPingTime = 0;
        let currentPing = 0;

        // === NETWORKING ===
        function connect() {
            const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(proto + '//' + location.host + '/ws');
            
            ws.onopen = () => {
                statusDot.classList.add('connected');
                statusText.textContent = 'Connected';
                ws.send(JSON.stringify({ type: 'hello', name: myName }));
            };
            
            ws.onclose = () => {
                statusDot.classList.remove('connected');
                statusText.textContent = 'Disconnected';
                setTimeout(connect, 2000);
            };
            
            ws.onerror = (e) => console.error('WS error:', e);
            
            ws.onmessage = (e) => {
                const data = JSON.parse(e.data);
                handleMessage(data);
            };
        }

        function handleMessage(data) {
            if (data.type === 'welcome') {
                myId = data.id;
                playerNameEl.textContent = myName;
                return;
            }
            
            if (data.type === 'state') {
                // Update server state
                myId = data.yourId || myId;
                
                // Convert players array to object
                const newPlayers = {};
                if (data.players) {
                    for (const p of data.players) {
                        newPlayers[p.id] = p;
                    }
                }
                serverState = newPlayers;
                playerCountEl.textContent = Object.keys(serverState).length;
                
                // Update my position
                if (serverState[myId]) {
                    myServerPos = {
                        x: serverState[myId].x,
                        y: serverState[myId].y
                    };
                    posDisplay.textContent = `(${Math.round(myServerPos.x)}, ${Math.round(myServerPos.y)})`;
                }
                return;
            }
        }

        // === INPUT ===
        function startMove(dx, dy) {
            currentInput = { dx, dy };
            sendInput();
            // Continuous sending while held
            if (!inputInterval) {
                inputInterval = setInterval(sendInput, SEND_RATE);
            }
        }

        function stopMove() {
            currentInput = { dx: 0, dy: 0 };
            if (inputInterval) {
                clearInterval(inputInterval);
                inputInterval = null;
            }
            sendInput(); // Send final stop
        }

        function sendInput() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'input',
                    dx: currentInput.dx,
                    dy: currentInput.dy
                }));
            }
        }

        function setName() {
            const name = prompt('Enter your name:', myName);
            if (name && name.trim()) {
                myName = name.trim();
                playerNameEl.textContent = myName;
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'hello', name: myName }));
                }
            }
        }

        // Keyboard controls
        const keyState = {};
        
        document.addEventListener('keydown', (e) => {
            if (keyState[e.key]) return; // Already pressed
            keyState[e.key] = true;
            
            switch(e.key.toLowerCase()) {
                case 'arrowleft': case 'a':
                    startMove(-1, 0); break;
                case 'arrowright': case 'd':
                    startMove(1, 0); break;
                case 'arrowup': case 'w':
                    startMove(0, -1); break;
                case 'arrowdown': case 's':
                    startMove(0, 1); break;
            }
        });

        document.addEventListener('keyup', (e) => {
            keyState[e.key] = false;
            
            // Check if any movement key still pressed
            const stillMoving =
                keyState['arrowleft'] || keyState['a'] ||
                keyState['arrowright'] || keyState['d'] ||
                keyState['arrowup'] || keyState['w'] ||
                keyState['arrowdown'] || keyState['s'];
            
            if (!stillMoving) {
                stopMove();
            }
        });

        // === RENDERING ===
        function render() {
            const now = performance.now();
            
            // FPS calculation
            frameCount++;
            if (now - lastFrameTime >= 1000) {
                fpsEl.textContent = frameCount;
                frameCount = 0;
                lastFrameTime = now;
            }
            
            // Clear canvas
            ctx.fillStyle = '#050508';
            ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);
            
            // Draw grid
            ctx.strokeStyle = '#101018';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 10; i++) {
                const pos = i * 100 * SCALE;
                ctx.beginPath();
                ctx.moveTo(pos, 0);
                ctx.lineTo(pos, CANVAS_SIZE);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(0, pos);
                ctx.lineTo(CANVAS_SIZE, pos);
                ctx.stroke();
            }
            
            // Draw center crosshair
            ctx.strokeStyle = '#1a1a2a';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(CANVAS_SIZE/2 - 20, CANVAS_SIZE/2);
            ctx.lineTo(CANVAS_SIZE/2 + 20, CANVAS_SIZE/2);
            ctx.moveTo(CANVAS_SIZE/2, CANVAS_SIZE/2 - 20);
            ctx.lineTo(CANVAS_SIZE/2, CANVAS_SIZE/2 + 20);
            ctx.stroke();
            
            // Draw players
            for (const [id, player] of Object.entries(serverState)) {
                const isMe = id === myId;
                const x = player.x * SCALE;
                const y = player.y * SCALE;
                
                // Player circle
                ctx.beginPath();
                ctx.arc(x, y, isMe ? PLAYER_RADIUS : PLAYER_RADIUS - 3, 0, Math.PI * 2);
                
                if (isMe) {
                    // My player - cyan with glow
                    ctx.shadowColor = '#00d4ff';
                    ctx.shadowBlur = 15;
                    ctx.fillStyle = '#00d4ff';
                } else {
                    // Other players - different colors based on ID hash
                    const hue = hashId(id) % 360;
                    ctx.shadowColor = `hsl(${hue}, 70%, 50%)`;
                    ctx.shadowBlur = 8;
                    ctx.fillStyle = `hsl(${hue}, 70%, 60%)`;
                }
                ctx.fill();
                ctx.shadowBlur = 0;
                
                // Name label
                ctx.fillStyle = isMe ? '#fff' : '#888';
                ctx.font = `${isMe ? 'bold ' : ''}11px system-ui`;
                ctx.textAlign = 'center';
                ctx.fillText(player.name || id.slice(0, 6), x, y + PLAYER_RADIUS + 14);
            }
            
            // Draw "you are here" indicator if we have position
            if (!serverState[myId] && myServerPos) {
                const x = myServerPos.x * SCALE;
                const y = myServerPos.y * SCALE;
                ctx.beginPath();
                ctx.arc(x, y, PLAYER_RADIUS, 0, Math.PI * 2);
                ctx.fillStyle = '#00d4ff';
                ctx.shadowColor = '#00d4ff';
                ctx.shadowBlur = 15;
                ctx.fill();
                ctx.shadowBlur = 0;
            }
            
            requestAnimationFrame(render);
        }

        function hashId(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = ((hash << 5) - hash) + str.charCodeAt(i);
                hash = hash & hash;
            }
            return Math.abs(hash);
        }

        // === INIT ===
        connect();
        render();
    </script>
</body>
</html>